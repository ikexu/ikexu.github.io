<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>利用HAProxy代理hadoop集群对外服务并做负载均衡 | kexu blog</title>
  <meta name="author" content="kexu">
  
  <meta name="description" content="java spark">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="利用HAProxy代理hadoop集群对外服务并做负载均衡"/>
  <meta property="og:site_name" content="kexu blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="kexu blog" type="application/atom+xml">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-368771XX-X']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class='normal_mode'>
    <nav id="main-nav">
  <ul class='container'>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
  </header>
  <div id="content" class="container">
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
      <time datetime="2016-07-20T14:56:17.786Z"><a href="/2016/07/20/利用HAProxy代理hadoop集群对外服务并做负载均衡/">Mié., Jul. 20 2016, 10:56:17 pm</a></time>

  
    <h1 class="title">利用HAProxy代理hadoop集群对外服务并做负载均衡</h1>
  



<div class="clear"></div>
      
    </header>
    <div class="entry">
      
        <h2 id="需求">需求</h2><p>在企业级hadoop集群使用过程中有时需要外部网络来访问hadoop内部网络,比如外部网络访问hdfs中文件,但是根据hdfs文件访问流程知道客户端并不直接从namenode获取数据,而是通过namenode查询到数据位置后,返回给客户端一个datanode地址供客户端与datanode建立通信,这时问题就来了,namenode返回的地址为hadoop内部地址,外部网络无法访问,此时客户端怎么获取到数据呢?<br><a id="more"></a><br>因此我们在hadoop集群内部构建一台接口机,使其能被外部网络和内部网络访问,在此接口上部署httpfs服务(部署方式这里略去),用haproxy代理httpfs服务地址,这样就能使外部网络访问hdfs,同样的道理我们可以代理hiveserver,hbase rest api,以及impala服务等等,haproxy作为了连通内部与外部网络的桥梁.不光如此,在企业级集群中hiveserver可能几十上百个,Impala Daemon也可能几十上百个甚至更多,为了保证每个机子能够均匀的处理业务,我们需要对他们做负载均衡,而这些HAProxy也能做到.</p>
<h2 id="HAProxy安装">HAProxy安装</h2><h3 id="源码编译安装">源码编译安装</h3><p>安装GCC组件</p>
<p><code>sudo yum -y install gcc*</code></p>
<p>安装ssl</p>
<p><code>sudo yum -y install openssl-devel pcre-devel</code></p>
<p><a href="http://www.haproxy.org/#down" target="_blank" rel="external">下载HAProxy</a></p>
<p>解压到指定目录</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">tar</span> <span class="tag">-zxvf</span> <span class="tag">haproxy-1</span><span class="class">.6</span><span class="class">.6</span><span class="class">.tar</span><span class="class">.gz</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">cd</span> <span class="tag">haproxy-1</span><span class="class">.6</span><span class="class">.6</span></span><br></pre></td></tr></table></figure>
<p>编译HAProxy</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make TARGET=linux2628 USE_PCRE=<span class="number">1</span> USE_OPENSSL=<span class="number">1</span> USE_ZLIB=<span class="number">1</span> USE_CRYPT_H=<span class="number">1</span> USE_LIBCRYPT=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>./haproxy -vv 查看是否安装成功</p>
<h3 id="rpm包安装">rpm包安装</h3><p>haproxy rpm资源地址：<a href="http://www.rpmfind.net/linux/rpm2html/search.php?query=haproxy" target="_blank" rel="external">http://www.rpmfind.net/linux/rpm2html/search.php?query=haproxy</a><br>下载后按照rpm方式安装<br>配置文件会默认安装在/etc/haproxy/haproxy.cfg,按照下面的流程修改配置文件(这种方式不需要在haproxy主目录下新建配置文件)<br>查看是否安装成功:haproxy -vv<br>启动方式:service haproxy start </p>
<p>配置HAProxy</p>
<p>配置参数说明<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">####################全局配置信息######################## </span></span><br><span class="line"><span class="preprocessor">#######参数是进程级的，通常和操作系统（OS）相关######### </span></span><br><span class="line">global </span><br><span class="line">       maxconn <span class="number">20480</span> <span class="preprocessor">#默认最大连接数 </span></span><br><span class="line">       <span class="built_in">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local3 <span class="preprocessor">#[err <span class="keyword">warning</span> info debug] </span></span><br><span class="line">       chroot /var/haproxy <span class="preprocessor">#chroot运行的路径 </span></span><br><span class="line">       uid <span class="number">99</span> <span class="preprocessor">#所属运行的用户uid </span></span><br><span class="line">       gid <span class="number">99</span> <span class="preprocessor">#所属运行的用户组 </span></span><br><span class="line">       daemon <span class="preprocessor">#以后台形式运行haproxy </span></span><br><span class="line">       nbproc <span class="number">1</span> <span class="preprocessor">#进程数量(可以设置多个进程提高性能) </span></span><br><span class="line">       pidfile /var/run/haproxy.pid <span class="preprocessor">#haproxy的pid存放路径,启动进程的用户必须有权限访问此文件 </span></span><br><span class="line">       ulimit-n <span class="number">65535</span> <span class="preprocessor">#ulimit的数量限制 </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">#####################默认的全局设置###################### </span></span><br><span class="line"><span class="preprocessor">##这些参数可以被利用配置到frontend，backend，listen组件## </span></span><br><span class="line">defaults </span><br><span class="line">       <span class="built_in">log</span> global </span><br><span class="line">       mode http <span class="preprocessor">#所处理的类别 (#<span class="number">7</span>层 http;<span class="number">4</span>层tcp ) </span></span><br><span class="line">       maxconn <span class="number">20480</span> <span class="preprocessor">#最大连接数 </span></span><br><span class="line">       option httplog <span class="preprocessor">#日志类别http日志格式 </span></span><br><span class="line">       option httpclose <span class="preprocessor">#每次请求完毕后主动关闭http通道 </span></span><br><span class="line">       option dontlognull <span class="preprocessor">#不记录健康检查的日志信息 </span></span><br><span class="line">       option forwardfor <span class="preprocessor">#如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip </span></span><br><span class="line">       option redispatch <span class="preprocessor">#serverId对应的服务器挂掉后,强制定向到其他健康的服务器 </span></span><br><span class="line">       option abortonclose <span class="preprocessor">#当服务器负载很高的时候，自动结束掉当前队列处理比较久的连接 </span></span><br><span class="line">       stats refresh <span class="number">30</span> <span class="preprocessor">#统计页面刷新间隔 </span></span><br><span class="line">       retries <span class="number">3</span> <span class="preprocessor">#<span class="number">3</span>次连接失败就认为服务不可用，也可以通过后面设置 </span></span><br><span class="line">       balance roundrobin <span class="preprocessor">#默认的负载均衡的方式,轮询方式 </span></span><br><span class="line">      <span class="preprocessor">#balance source #默认的负载均衡的方式,类似nginx的ip_hash </span></span><br><span class="line">      <span class="preprocessor">#balance leastconn #默认的负载均衡的方式,最小连接 </span></span><br><span class="line">       contimeout <span class="number">5000</span> <span class="preprocessor">#连接超时 </span></span><br><span class="line">       clitimeout <span class="number">50000</span> <span class="preprocessor">#客户端超时 </span></span><br><span class="line">       srvtimeout <span class="number">50000</span> <span class="preprocessor">#服务器超时 </span></span><br><span class="line">       timeout check <span class="number">2000</span> <span class="preprocessor">#心跳检测超时 </span></span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">####################监控页面的设置####################### </span></span><br><span class="line">listen admin_status <span class="preprocessor">#Frontend和Backend的组合体,监控组的名称，按需自定义名称 </span></span><br><span class="line">        bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">65532</span> <span class="preprocessor">#监听端口 </span></span><br><span class="line">        mode http <span class="preprocessor">#http的<span class="number">7</span>层模式 </span></span><br><span class="line">        <span class="built_in">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local3 err <span class="preprocessor">#错误日志记录 </span></span><br><span class="line">        stats refresh <span class="number">5</span>s <span class="preprocessor">#每隔<span class="number">5</span>秒自动刷新监控页面 </span></span><br><span class="line">        stats uri /admin?stats <span class="preprocessor">#监控页面的url </span></span><br><span class="line">        stats realm itnihao\ itnihao <span class="preprocessor">#监控页面的提示信息 </span></span><br><span class="line">        stats auth admin:admin <span class="preprocessor">#监控页面的用户和密码admin,可以设置多个用户名 </span></span><br><span class="line">        stats auth admin1:admin1 <span class="preprocessor">#监控页面的用户和密码admin1 </span></span><br><span class="line">        stats hide-version <span class="preprocessor">#隐藏统计页面上的HAproxy版本信息 </span></span><br><span class="line">        stats admin <span class="keyword">if</span> TRUE <span class="preprocessor">#手工启用/禁用,后端服务器(haproxy-<span class="number">1.4</span><span class="number">.9</span>以后版本) </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">       errorfile <span class="number">403</span> /etc/haproxy/errorfiles/<span class="number">403.</span>http </span><br><span class="line">       errorfile <span class="number">500</span> /etc/haproxy/errorfiles/<span class="number">500.</span>http </span><br><span class="line">       errorfile <span class="number">502</span> /etc/haproxy/errorfiles/<span class="number">502.</span>http </span><br><span class="line">       errorfile <span class="number">503</span> /etc/haproxy/errorfiles/<span class="number">503.</span>http </span><br><span class="line">       errorfile <span class="number">504</span> /etc/haproxy/errorfiles/<span class="number">504.</span>http </span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">#################HAProxy的日志记录内容设置################### </span></span><br><span class="line">       capture request header Host len <span class="number">40</span> </span><br><span class="line">       capture request header Content-Length len <span class="number">10</span> </span><br><span class="line">       capture request header Referer len <span class="number">200</span> </span><br><span class="line">       capture response header Server len <span class="number">40</span> </span><br><span class="line">       capture response header Content-Length len <span class="number">10</span> </span><br><span class="line">       capture response header Cache-Control len <span class="number">8</span> </span><br><span class="line">     </span><br><span class="line"><span class="preprocessor">#######################网站监测listen配置##################### </span></span><br><span class="line"><span class="preprocessor">###########此用法主要是监控haproxy后端服务器的监控状态############ </span></span><br><span class="line">listen site_status </span><br><span class="line">       bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1081</span> <span class="preprocessor">#监听端口 </span></span><br><span class="line">       mode http <span class="preprocessor">#http的<span class="number">7</span>层模式 </span></span><br><span class="line">       <span class="built_in">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local3 err <span class="preprocessor">#[err <span class="keyword">warning</span> info debug] </span></span><br><span class="line">       monitor-uri /site_status <span class="preprocessor">#网站健康检测URL，用来检测HAProxy管理的网站是否可以用，正常返回<span class="number">200</span>，不正常返回<span class="number">503</span> </span></span><br><span class="line">       <span class="function">acl site_dead <span class="title">nbsrv</span><span class="params">(server_web)</span> lt 2 #定义网站down时的策略当挂在负载均衡上的指定backend的中有效机器数小于1台时返回<span class="literal">true</span> </span><br><span class="line">       acl site_dead <span class="title">nbsrv</span><span class="params">(server_blog)</span> lt 2 </span><br><span class="line">       acl site_dead <span class="title">nbsrv</span><span class="params">(server_bbs)</span> lt 2 </span><br><span class="line">       monitor fail <span class="keyword">if</span> site_dead #当满足策略的时候返回503，网上文档说的是500，实际测试为503 </span><br><span class="line">       monitor-net 192.168.16.2/32 #来自192.168.16.2的日志信息不会被记录和转发 </span><br><span class="line">       monitor-net 192.168.16.3/32 </span><br><span class="line"> </span><br><span class="line">########frontend配置############ </span><br><span class="line">#####注意，frontend配置里面可以定义多个acl进行匹配操作######## </span><br><span class="line">frontend http_80_in </span><br><span class="line">       bind 0.0.0.0:80 #监听端口，即haproxy提供web服务的端口，和lvs的vip端口类似 </span><br><span class="line">       mode http #http的7层模式 </span><br><span class="line">       <span class="built_in">log</span> global #应用全局的日志配置 </span><br><span class="line">       option httplog #启用http的<span class="built_in">log</span> </span><br><span class="line">       option httpclose #每次请求完毕后主动关闭http通道，HA-Proxy不支持keep-alive模式 </span><br><span class="line">       option forwardfor #如果后端服务器需要获得客户端的真实IP需要配置次参数，将可以从Http Header中获得客户端IP </span><br><span class="line">       ########acl策略配置############# </span><br><span class="line">       acl itnihao_web <span class="title">hdr_reg</span><span class="params">(host)</span> -i ^<span class="params">(www.itnihao.cn|ww1.itnihao.cn)</span>$ </span><br><span class="line">       #如果请求的域名满足正则表达式中的2个域名返回<span class="literal">true</span> -i是忽略大小写 </span><br><span class="line">       acl itnihao_blog <span class="title">hdr_dom</span><span class="params">(host)</span> -i blog.itnihao.cn </span><br><span class="line">       #如果请求的域名满足www.itnihao.cn返回<span class="literal">true</span> -i是忽略大小写 </span><br><span class="line">       #acl itnihao <span class="title">hdr</span><span class="params">(host)</span> -i itnihao.cn </span><br><span class="line">       #如果请求的域名满足itnihao.cn返回<span class="literal">true</span> -i是忽略大小写 </span><br><span class="line">       #acl file_req url_sub -i killall</span>= </span><br><span class="line">       <span class="preprocessor">#在请求url中包含killall=，则此控制策略返回true,否则为false </span></span><br><span class="line">       <span class="preprocessor">#acl dir_req url_dir -i allow </span></span><br><span class="line">       <span class="preprocessor">#在请求url中存在allow作为部分地址路径，则此控制策略返回true,否则返回false </span></span><br><span class="line">       <span class="preprocessor">#acl missing_cl hdr_cnt(Content-length) eq <span class="number">0</span> </span></span><br><span class="line">       <span class="preprocessor">#当请求的header中Content-length等于<span class="number">0</span>时返回true </span></span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">########acl策略匹配相应############# </span></span><br><span class="line">       <span class="preprocessor">#block <span class="keyword">if</span> missing_cl </span></span><br><span class="line">       <span class="preprocessor">#当请求中header中Content-length等于<span class="number">0</span>阻止请求返回<span class="number">403</span> </span></span><br><span class="line">       <span class="preprocessor">#block <span class="keyword">if</span> !file_req || dir_req </span></span><br><span class="line">       <span class="preprocessor">#block表示阻止请求，返回<span class="number">403</span>错误，当前表示如果不满足策略file_req，或者满足策略dir_req，则阻止请求 </span></span><br><span class="line">       use_backend server_web <span class="keyword">if</span> itnihao_web </span><br><span class="line">       <span class="preprocessor">#当满足itnihao_web的策略时使用server_web的backend </span></span><br><span class="line">       use_backend server_blog <span class="keyword">if</span> itnihao_blog </span><br><span class="line">       <span class="preprocessor">#当满足itnihao_blog的策略时使用server_blog的backend </span></span><br><span class="line">       <span class="preprocessor">#redirect prefix http:<span class="comment">//blog.itniaho.cn code 301 if itnihao </span></span></span><br><span class="line">       <span class="preprocessor">#当访问itnihao.cn的时候，用http的<span class="number">301</span>挑转到http:<span class="comment">//192.168.16.3 </span></span></span><br><span class="line">       default_backend server_bbs </span><br><span class="line">       <span class="preprocessor">#以上都不满足的时候使用默认server_bbs的backend </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">##########backend的设置############## </span></span><br><span class="line"><span class="preprocessor">#下面我将设置三组服务器 server_web，server_blog，server_bbs</span></span><br><span class="line"><span class="preprocessor">##################backend server_web####################</span></span><br><span class="line">backend server_web </span><br><span class="line">       mode http <span class="preprocessor">#http的<span class="number">7</span>层模式 </span></span><br><span class="line">       balance roundrobin <span class="preprocessor">#负载均衡的方式，roundrobin平均方式 </span></span><br><span class="line">       cookie SERVERID <span class="preprocessor">#允许插入serverid到cookie中，serverid后面可以定义 </span></span><br><span class="line">       option httpchk GET /index.html <span class="preprocessor">#心跳检测的文件 </span></span><br><span class="line">       server web1 <span class="number">192.168</span><span class="number">.16</span><span class="number">.2</span>:<span class="number">80</span> cookie web1 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">1</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为web1，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用， </span></span><br><span class="line">       <span class="preprocessor">#fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重 </span></span><br><span class="line">       server web2 <span class="number">192.168</span><span class="number">.16</span><span class="number">.3</span>:<span class="number">80</span> cookie web2 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">2</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为web2，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用， </span></span><br><span class="line">       <span class="preprocessor">#fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重 </span></span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">###################backend server_blog######################</span></span><br><span class="line">backend server_blog </span><br><span class="line">       mode http <span class="preprocessor">#http的<span class="number">7</span>层模式 </span></span><br><span class="line">       balance roundrobin <span class="preprocessor">#负载均衡的方式，roundrobin平均方式 </span></span><br><span class="line">       cookie SERVERID <span class="preprocessor">#允许插入serverid到cookie中，serverid后面可以定义 </span></span><br><span class="line">       option httpchk GET /index.html <span class="preprocessor">#心跳检测的文件 </span></span><br><span class="line">       server blog1 <span class="number">192.168</span><span class="number">.16</span><span class="number">.2</span>:<span class="number">80</span> cookie blog1 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">1</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为blog1，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用，fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重 </span></span><br><span class="line">       server blog2 <span class="number">192.168</span><span class="number">.16</span><span class="number">.3</span>:<span class="number">80</span> cookie blog2 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">2</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为blog2，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用，fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重 </span></span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">##################backend server_bbs######################## </span></span><br><span class="line"> </span><br><span class="line">backend server_bbs </span><br><span class="line">       mode http <span class="preprocessor">#http的<span class="number">7</span>层模式 </span></span><br><span class="line">       balance roundrobin <span class="preprocessor">#负载均衡的方式，roundrobin平均方式 </span></span><br><span class="line">       cookie SERVERID <span class="preprocessor">#允许插入serverid到cookie中，serverid后面可以定义 </span></span><br><span class="line">       option httpchk GET /index.html <span class="preprocessor">#心跳检测的文件 </span></span><br><span class="line">       server bbs1 <span class="number">192.168</span><span class="number">.16</span><span class="number">.2</span>:<span class="number">80</span> cookie bbs1 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">1</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为bbs1，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用，fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重 </span></span><br><span class="line">       server bbs2 <span class="number">192.168</span><span class="number">.16</span><span class="number">.3</span>:<span class="number">80</span> cookie bbs2 check inter <span class="number">1500</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">2</span> </span><br><span class="line">       <span class="preprocessor">#服务器定义，cookie <span class="number">1</span>表示serverid为bbs2，check inter <span class="number">1500</span>是检测心跳频率rise <span class="number">3</span>是<span class="number">3</span>次正确认为服务器可用，fall <span class="number">3</span>是<span class="number">3</span>次失败认为服务器不可用，weight代表权重</span></span><br></pre></td></tr></table></figure></p>
<h2 id="配置样例">配置样例</h2><p>在HAProxy主目录下新建一个config.cfg文件 配置以下:<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">daemon</span><br><span class="line">nbproc 1</span><br><span class="line">defaults</span><br><span class="line">mode tcp <span class="comment">#mode &#123; tcp|http|health &#125;，tcp 表示4层，http表示7层，health仅作为健康检查使用</span></span><br><span class="line">retries 2 <span class="comment">#尝试2次失败则从集群摘除</span></span><br><span class="line">option redispatch <span class="comment">#如果失效则强制转换其他服务器</span></span><br><span class="line">option abortonclose <span class="comment">#连接数过大自动关闭</span></span><br><span class="line">maxconn 2048 <span class="comment">#最大连接数</span></span><br><span class="line">timeout connect 1d <span class="comment">#连接超时时间，重要，hive查询数据能返回结果的保证</span></span><br><span class="line">timeout client 1d <span class="comment">#同上</span></span><br><span class="line">timeout server 1d <span class="comment">#同上</span></span><br><span class="line">timeout<span class="instruction"> check </span>2000 <span class="comment">#健康检查时间</span></span><br><span class="line">log 127.0.0.1 local0 err <span class="comment">#[err warning info debug]</span></span><br><span class="line">listen admin_stats <span class="comment">#定义管理界面</span></span><br><span class="line">bind 192.168.1.200:10900 <span class="comment">#管理界面访问IP和端口</span></span><br><span class="line">mode http <span class="comment">#管理界面所使用的协议</span></span><br><span class="line">maxconn 25 <span class="comment">#最大连接数</span></span><br><span class="line">stats refresh 30s <span class="comment">#30秒自动刷新</span></span><br><span class="line">stats uri /hivestate <span class="comment">#访问url</span></span><br><span class="line">stats realm Hive\ Haproxy <span class="comment">#验证窗口提示</span></span><br><span class="line">stats auth admin:123456 <span class="comment">#401验证用户名密码</span></span><br><span class="line"></span><br><span class="line">listen hive <span class="comment">#hive后端定义</span></span><br><span class="line">bind 0.0.0.0:10001 <span class="comment">#ha作为proxy所绑定的IP和端口</span></span><br><span class="line">mode tcp <span class="comment">#以4层方式代理，重要</span></span><br><span class="line">balance roundrobin <span class="comment">#调度算法 'leastconn' 最少连接数分配，或者 'roundrobin'，轮询分配</span></span><br><span class="line">maxconn 1024 <span class="comment">#最大连接数</span></span><br><span class="line">server hive_1 192.168.1.200:10000<span class="instruction"> check </span>inter 180000 rise 1 fall 2</span><br><span class="line">server hive_2 192.168.1.202:10000<span class="instruction"> check </span>inter 180000 rise 1 fall 2</span><br><span class="line">server hive_3 192.168.1.203:10000<span class="instruction"> check </span>inter 180000 rise 1 fall 2</span><br><span class="line">server hive_4 192.168.1.204:10000<span class="instruction"> check </span>inter 180000 rise 1 fall 2</span><br><span class="line">释义：server<span class="function"> 主机代名(</span>web页面会显示区分<span class="function">)</span>，IP:端口 每180000毫秒检查一次。也就是三分钟.hive每有10000端口的请求就会创建一个log，设置短了，/tmp下面会有无数个log文件，删不完。</span><br><span class="line"></span><br><span class="line">listen httpfs</span><br><span class="line">bind 192.168.1.200:14001</span><br><span class="line">mode tcp</span><br><span class="line">balance roundrobin</span><br><span class="line">maxconn 1024</span><br><span class="line">server hdfs_1 192.168.1.200:14000<span class="instruction"> check </span>inter 180000 rise 1 fall 2</span><br></pre></td></tr></table></figure></p>
<p>从上面可以得出:<br>web管理页面地址:192.168.1.200:10900/hivestate,用户名:admin,密码:123456<br>对外统一hiveserver2接口:192.168.1.200:10001<br>对外统一httpfs接口:192.168.1.200:14001<br>上面配置了hiveserver和httpfs的代理,其余服务与这个类似</p>
<h2 id="启动HAProxy">启动HAProxy</h2><p>在HAProxy主目录下:<br>./haproxy -f config.cfg #config.cfg即是刚刚新建的HAProxy配置文件</p>
<p>访问web页面查看监控信息:<br>如果能正确显示信息则配置正确</p>
<h2 id="监测页面参数项说明">监测页面参数项说明</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Queue</span><br><span class="line"><span class="string">Cur:</span> current queued requests <span class="comment">//当前的队列请求数量</span></span><br><span class="line">Max：max queued requests     <span class="comment">//最大的队列请求数量</span></span><br><span class="line">Limit：           <span class="comment">//队列限制数量</span></span><br><span class="line">Session rate(每秒的连接回话)列表：</span><br><span class="line"><span class="string">scur:</span> current sessions        <span class="comment">//每秒的当前回话的限制数量</span></span><br><span class="line"><span class="string">smax:</span> max sessions           <span class="comment">//每秒的新的最大的回话量</span></span><br><span class="line"><span class="string">slim:</span> sessions limit           <span class="comment">//每秒的新回话的限制数量</span></span><br><span class="line">Sessions </span><br><span class="line"><span class="string">Total:</span>            <span class="comment">//总共回话量 </span></span><br><span class="line"><span class="string">Cur:</span>             <span class="comment">//当前的回话</span></span><br><span class="line"><span class="string">Max:</span> <span class="comment">//最大回话 </span></span><br><span class="line"><span class="string">Limit:</span> <span class="comment">//回话限制</span></span><br><span class="line"><span class="string">Lbtot:</span> total number of times a server was selected  <span class="comment">//选中一台服务器所用的总时间</span></span><br><span class="line">Bytes</span><br><span class="line">In： <span class="comment">//网络的字节数输入总量  </span></span><br><span class="line">Out： <span class="comment">//网络的字节数输出总量</span></span><br><span class="line">Denied</span><br><span class="line"><span class="string">Req:</span> denied requests<span class="comment">//拒绝请求量</span></span><br><span class="line">Resp：denied responses <span class="comment">//拒绝回应</span></span><br><span class="line">Errors</span><br><span class="line">Req：request errors             <span class="comment">//错误请求 </span></span><br><span class="line">Conn：connection errors          <span class="comment">//错误的连接</span></span><br><span class="line"><span class="string">Resp:</span> response errors (among which srv_abrt)  <span class="comment">///错误的回应</span></span><br><span class="line">Warnings</span><br><span class="line"><span class="string">Retr:</span> retries (warning)                      <span class="comment">//重新尝试</span></span><br><span class="line">Redis：redispatches (warning)               <span class="comment">//再次发送</span></span><br><span class="line">Server列表：</span><br><span class="line"><span class="string">Status:</span>状态，包括up(后端机活动)和down(后端机挂掉)两种状态</span><br><span class="line"><span class="string">LastChk:</span>    持续检查后端服务器的时间</span><br><span class="line"><span class="string">Wght:</span> (weight) : 权重</span><br><span class="line"><span class="string">Act:</span> server is active (server), number of active servers (backend) <span class="comment">//活动链接数量</span></span><br><span class="line"><span class="string">Bck:</span> server is backup (server), number of backup servers (backend) <span class="comment">//backup：备份的服务器数量</span></span><br><span class="line">Down：          <span class="comment">//后端服务器连接后都是down的数量</span></span><br><span class="line"><span class="string">Downtime:</span> <span class="string">downtime:</span> total downtime (<span class="keyword">in</span> seconds)    <span class="comment">//总的downtime 时间</span></span><br><span class="line"><span class="string">Throttle:</span> warm up status                          <span class="comment">//设备变热状态</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
          
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <span class="jiathis_txt">分享到：</span>
  <a class="jiathis_button_weixin">微信</a>
  <a class="jiathis_button_tsina">新浪微博</a>
  <a class="jiathis_button_renren">人人网</a>
  <a class="jiathis_button_qzone">QQ空间</a>
  <a class="jiathis_button_douban">豆瓣</a>
  <a class="jiathis_button_pocket">Pocket</a>
  <a href="http://www.jiathis.com/share?uid=901656" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=901656" charset="utf-8"></script>
<!-- JiaThis Button END -->

          <div class="clearfix"></div>
          <nav id="pagination">
  
  
    <a href="/2016/07/20/CarbonData学习笔记/" class="alignright next">Prev<i class="fa fa-long-arrow-right"></i></a>
  
  <div class="clearfix"></div>
</nav>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comentarios</h1>

  
      <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-thread-key="/2016/07/20/利用HAProxy代理hadoop集群对外服务并做负载均衡/"></div>
<!-- Duoshuo Comment END -->
  
</section>



    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div>
  
  &copy; 2016 kexu
  
</div>
Powered by <a href="http://zespia.tw/hexo/" title="Hexo" target="_blank" rel="external">Hexo</a> and <a href="http://pages.github.com/" title="GitHub Pages" target="_blank" rel="external">GitHub Pages</a>

<div class="clearfix"></div></footer>
  
<script src="/js/jquery.imagesloaded.min.js" type="text/javascript"></script>
<script src="/js/gallery.js" type="text/javascript"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js" type="text/javascript"></script>




    <script type="text/javascript">
        (function(){

            $(window).scroll(function(){

                var scrollTop = $(window).scrollTop();
                if ( scrollTop >200 ){
                    $("#main-nav").removeClass('normal_mode').addClass('top_mode');
                } else{
                    $("#main-nav").removeClass('top_mode').addClass('normal_mode');
                }

            });

        })();
    </script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
  (function($){
    $('.fancybox').fancybox({
      'titlePosition': 'inside'
    });
  })(jQuery);
  </script>



    
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"meitianxiaoxu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = 'http://static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



<script type="text/javascript">
  
  $(function(){

    $('.title').hover(
      function() {      
        $(this).stop().animate(
          {'marginLeft': '10px'}, 200
        );   
      }, 
      function() {       
        $(this).stop().animate({'marginLeft': '0px'}, 200);      
      
    });   

  });

</script>


</body>
</html>